name: Terraform AWS Pipeline Blueprint Setup Module
#logo: logo/logo.jpg

license: "APACHE2"

copyrights:
  - name: "Cloud Ops Works LLC"
    url: "https://cloudops.works"
    year: "2024"

github_repo: cloudopsworks/terraform-module-aws-pipeline-blueprint

description: |-
  A comprehensive Terraform module designed to automate the setup of AWS pipeline blueprints. This module streamlines the creation of IAM roles, policies, and users for various services including EKS, ArgoCD, Elastic Beanstalk, Lambda, DNS Manager, and SSM Session Manager, following security best practices and organizational standards.

# Introduction to the project
introduction: |-
  The Terraform AWS Pipeline Blueprint Setup Module provides a standardized way to deploy infrastructure roles and permissions across AWS accounts. It supports both Hub and Spoke configurations, allowing for centralized management of deployment identities and localized resource permissions.

  Key capabilities include:
  - Hub and Spoke architecture support
  - IAM role and group management for CI/CD publishers (Preview, Build, Terraform)
  - Integration with ArgoCD and EKS for Kubernetes deployments
  - Support for Elastic Beanstalk and Lambda application environments
  - DNS Management and SSM Session Manager security configurations
  - Database Migration Service (DMS) and Device Farm role setup

# How to use this project
usage: |-
  To use this module in your Terragrunt configuration, define the inputs in your `terragrunt.hcl` file.

  ### Terragrunt Usage Example
  ```hcl
  terraform {
    source = "git::https://github.com/cloudopsworks/terraform-module-aws-pipeline-blueprint.git?ref=v1.0.0"
  }

  inputs = {
    org = {
      organization_name = "my-org"         # (Required) Organization name
      organization_unit = "platform"       # (Required) Organization unit
      environment_type  = "prod"           # (Required) Environment type (prod, nonprod, sandbox)
      environment_name  = "production"     # (Required) Environment name
    }
    is_hub    = true                       # (Optional) Whether this is a HUB account. Default: false
    spoke_def = "001"                      # (Optional) Spoke ID. Default: "001"
    
    # Add other configurations as needed
  }
  ```

  ### Variables Documentation
  Below is the full documentation for the variables in YAML format:

  ```yaml
  is_hub: false                      # (Optional) Is this a hub or spoke configuration? Default: false
  spoke_def: "001"                   # (Optional) Spoke ID Number, must be a 3 digit number. Default: "001"
  org:                               # (Required) Organization details.
    organization_name: "my-org"      # (Required) Organization name.
    organization_unit: "my-unit"     # (Required) Organization unit.
    environment_type: "prod"         # (Required) Environment type (e.g. prod, staging).
    environment_name: "production"   # (Required) Environment name.
  extra_tags: {}                     # (Optional) Extra tags to add to the resources. Default: {}
  usernames:
    account_id: ""                   # (Optional) The AWS account ID. Default: ""
    preview_publisher: "eks-preview-publisher" # (Optional) The username for the preview publisher. Default: "eks-preview-publisher"
    terraform: "terraform-access"    # (Optional) The username for Terraform access. Default: "terraform-access"
    build_publisher: "build-publisher" # (Optional) The username for the build publisher. Default: "build-publisher"
  lambda_bucket_name: ""             # (Optional) The name of the S3 bucket for Lambda functions. Default: ""
  apideploy_bucket_name: ""          # (Optional) The name of the S3 bucket for API deployment Lambda functions. Default: ""
  beanstalk:
    bucket_name: ""                  # (Optional) Elastic Beanstalk bucket name. Default: ""
    service_role_name: "aws-elasticbeanstalk-service-role" # (Optional) Elastic Beanstalk service role name. Default: "aws-elasticbeanstalk-service-role"
    additional_buckets: []           # (Optional) List of additional S3 buckets for Beanstalk. Default: []
    additional_pass_roles: []        # (Optional) List of additional IAM roles to pass to Beanstalk. Default: []
  argocd:
    namespace: "argocd"              # (Optional) ArgoCD namespace. Default: "argocd"
    cluster_name: ""                 # (Optional) ArgoCD cluster name. Default: ""
    controller_serviceaccount_name: "argocd-application-controller" # (Optional) ArgoCD controller service account name. Default: "argocd-application-controller"
    server_serviceaccount_name: "argocd-server" # (Optional) ArgoCD server service account name. Default: "argocd-server"
    role_arns: []                    # (Optional) List of role ARNs for ArgoCD. Default: []
  dns_manager:
    enabled: false                   # (Optional) Enable DNS Manager. Default: false
    role_arns: []                    # (Optional) List of role ARNs for DNS Manager. Default: []
  ssm_session_manager:
    logs_bucket_name: ""             # (Optional) S3 bucket name for SSM Session Manager logs. Default: ""
    kms_key_arn: ""                  # (Optional) KMS key ARN for SSM Session Manager. Default: ""
  dms_enabled: false                 # (Optional) Flag to enable DMS (Database Migration Service) resources. Default: false
  eks:
    enabled: false                   # (Optional) Enable EKS cluster configuration. Default: false
    clusters:                        # (Optional) List of EKS clusters configuration. Default: []
      - name: "my-cluster"           # (Required) EKS cluster name.
        excluded: false              # (Optional) Exclude this cluster. Default: false
  hoop:
    enabled: false                   # (Optional) Enable Hoop configuration. Default: false
    namespace: "hoopagent"           # (Optional) Hoop namespace. Default: "hoopagent"
    serviceaccount_name: "hoopagent" # (Optional) Hoop service account name. Default: "hoopagent"
  secrets_manager_arns: []           # (Optional) A list of ARNs for Secrets Manager secrets. Default: []
  lambda_pass_role_arns: []          # (Optional) A list of ARNs for Lambda pass roles. Default: []
  service_linked_roles: []           # (Optional) A list of service-linked roles to create. Default: []
  groups:
    preview_publisher:               # (Optional) Preview publisher group settings.
      name: "eks-preview-publisher"  # (Required) Group name.
      roles:                         # (Required) List of roles for the group.
        - account_id: "123456789012" # (Required) AWS Account ID.
          role_names: ["role1"]      # (Required) List of role names.
    terraform:                       # (Optional) Terraform access group settings.
      name: "terraform-access"       # (Required) Group name.
      roles:                         # (Required) List of roles for the group.
        - account_id: "123456789012" # (Required) AWS Account ID.
          role_names: ["role1"]      # (Required) List of role names.
    build_publisher:                 # (Optional) Build publisher group settings.
      name: "terraform-access"       # (Required) Group name.
      roles:                         # (Required) List of roles for the group.
        - account_id: "123456789012" # (Required) AWS Account ID.
          role_names: ["role1"]      # (Required) List of role names.
  device_farm_enabled: false         # (Optional) Flag to enable Device Farm resources. Default: false
  ```

# Example usage
examples: |-
  ### HUB Account Setup
  ```hcl
  # terragrunt.hcl
  include "root" {
    path = find_in_parent_folders()
  }

  terraform {
    source = "git::https://github.com/cloudopsworks/terraform-module-aws-pipeline-blueprint.git?ref=v1.0.0"
  }

  inputs = {
    is_hub = true
    org = {
      organization_name = "cloudopsworks"
      organization_unit = "platform"
      environment_type  = "prod"
      environment_name  = "production"
    }
    usernames = {
      account_id = "123456789012"
    }
    groups = {
      terraform = {
        name = "terraform-access"
        roles = [
          {
            account_id = "123456789012"
            role_names = ["AdministratorAccess"]
          }
        ]
      }
    }
  }
  ```

  ### Spoke Account Setup with EKS and ArgoCD
  ```hcl
  # terragrunt.hcl
  include "root" {
    path = find_in_parent_folders()
  }

  terraform {
    source = "git::https://github.com/cloudopsworks/terraform-module-aws-pipeline-blueprint.git?ref=v1.0.0"
  }

  inputs = {
    is_hub    = false
    spoke_def = "002"
    org = {
      organization_name = "cloudopsworks"
      organization_unit = "engineering"
      environment_type  = "nonprod"
      environment_name  = "staging"
    }
    eks = {
      enabled = true
      clusters = [
        {
          name     = "staging-cluster-1"
          excluded = false
        }
      ]
    }
    argocd = {
      namespace    = "argocd"
      cluster_name = "staging-cluster-1"
    }
  }
  ```

# How to get started quickly
quickstart: |-
  1. Ensure you have Terraform (v1.3+) and Terragrunt (v0.38+) installed.
  2. Create a `terragrunt.hcl` file in your environment directory.
  3. Configure the `org` variable and any service-specific variables (EKS, ArgoCD, Beanstalk, etc.).
  4. Run `terragrunt init` to initialize the module.
  5. Run `terragrunt plan` to review the infrastructure changes.
  6. Run `terragrunt apply` to deploy the blueprint.

include:
  - "docs/targets.md"
  - "docs/terraform.md"

contributors:
  - name: "Cristian Beraha"
    github: "berahac"